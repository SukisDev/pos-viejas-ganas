<!DOCTYPE html>
<html>
<head>
    <title>Test Calendar</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin: 20px 0; }
        .day { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .has-orders { background-color: #e6f3ff; color: #0066cc; font-weight: bold; }
        .selected { background-color: #0066cc; color: white; }
        .month-selector { margin: 20px 0; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #result { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>Test Calendar - Viejas Ganas</h1>
    
    <div class="month-selector">
        <button onclick="loadDates()">Cargar Fechas</button>
        <button onclick="testCalendar()">Test Calendar UI</button>
    </div>
    
    <div id="result"></div>
    
    <div id="calendar-container"></div>

    <script>
        let monthsWithOrders = [];
        let selectedDate = null;

        async function loadDates() {
            try {
                console.log('Fetching dates...');
                const response = await fetch('http://localhost:3000/api/admin/orders/dates');
                const data = await response.json();
                
                console.log('API Response:', data);
                document.getElementById('result').innerHTML = 
                    '<h3>API Response:</h3><pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                if (data.success) {
                    monthsWithOrders = data.monthsWithOrders;
                    if (monthsWithOrders.length > 0) {
                        renderCalendar(monthsWithOrders[0]);
                    }
                }
            } catch (error) {
                console.error('Error fetching dates:', error);
                document.getElementById('result').innerHTML = 
                    '<h3 style="color: red;">Error:</h3><p>' + error.message + '</p>';
            }
        }

        function testCalendar() {
            // Test data
            const testData = {
                monthKey: "2025-09",
                monthName: "Septiembre", 
                year: 2025,
                month: 9,
                dates: [
                    {date: "2025-09-07", count: 1, fullDate: "2025-09-07T00:00:00.000Z"},
                    {date: "2025-09-06", count: 1, fullDate: "2025-09-06T00:00:00.000Z"}
                ]
            };
            
            monthsWithOrders = [testData];
            renderCalendar(testData);
        }

        function renderCalendar(monthData) {
            const container = document.getElementById('calendar-container');
            const year = monthData.year;
            const month = monthData.month - 1; // JS months are 0-based
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(firstDay.getDate() - firstDay.getDay());
            
            let html = `<h2>${monthData.monthName} ${year}</h2>`;
            html += '<div class="calendar">';
            
            // Headers
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayNames.forEach(day => {
                html += `<div class="day" style="font-weight: bold; background: #f5f5f5;">${day}</div>`;
            });
            
            // Calendar days
            const currentDate = new Date(startDate);
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const dayNumber = currentDate.getDate();
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const dateString = currentDate.toISOString().split('T')[0];
                    
                    const hasOrders = monthData.dates.some(d => d.date === dateString);
                    const isSelected = selectedDate === dateString;
                    
                    let classes = 'day';
                    if (hasOrders) classes += ' has-orders';
                    if (isSelected) classes += ' selected';
                    if (!isCurrentMonth) classes += ' other-month';
                    
                    html += `<div class="${classes}" 
                                 onclick="selectDate('${dateString}')" 
                                 style="${!isCurrentMonth ? 'opacity: 0.3;' : ''} cursor: pointer;">
                                 ${dayNumber}
                                 ${hasOrders ? '<br><small>(' + monthData.dates.find(d => d.date === dateString)?.count + ')</small>' : ''}
                             </div>`;
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                if (currentDate.getMonth() !== month) break;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function selectDate(dateString) {
            selectedDate = dateString;
            console.log('Selected date:', dateString);
            
            // Re-render calendar with selection
            if (monthsWithOrders.length > 0) {
                renderCalendar(monthsWithOrders[0]);
            }
            
            // Show selected date info
            document.getElementById('result').innerHTML = 
                '<h3>Fecha seleccionada:</h3><p>' + dateString + '</p>';
        }
    </script>
</body>
</html>
